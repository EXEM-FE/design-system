# Load NVM and set PATH for pnpm (VSCode Source Control compatibility)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# 🔄 토큰 자동 생성 (stylesheet 변경 시)
if git diff --cached --name-only | grep -q "packages/stylesheet/src/global.css"; then
  echo "🔄 CSS 변경 감지 - 토큰 자동 생성 중..."
  pnpm --filter exem-design-token generate
  git add packages/design-token/src/tokens/*.ts
  echo "✅ 토큰 생성 완료 및 스테이징 추가됨"
fi

# 스테이징된 파일 목록 저장
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# 포맷팅 먼저 실행
echo "🎨 Formatting code..."
pnpm format

# 원래 스테이징된 파일들만 다시 스테이징
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | xargs git add
fi

# 린팅 실행 (Biome이 자동으로 dist 폴더 무시)
echo "🔍 Linting code..."
pnpm lint:fix || {
    echo "⚠️  Some lint issues remain (auto-generated files ignored)"
    exit 0
}

# 타입 체크 실행  
echo "🔧 Type checking..."
pnpm typecheck

echo "✅ Pre-commit checks passed!"
